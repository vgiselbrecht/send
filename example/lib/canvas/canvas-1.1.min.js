// (c) 2010 Priit Kallas

var Canvas=function(canvas,fps,renderCallback,autostart,layerParent,drawOnly){this.renderCallback=null;this.canvasContext='2d';this.autostart=autostart==null?true:autostart;this.autoResize=false;this.layerParent=layerParent;this.drawOnly=drawOnly!=null?drawOnly:false;this.canvasElement=null;this.c=null;this.targetFPS=fps!=null?fps:0;this.targetFrameDuration=this.targetFPS>0?1000.0/this.targetFPS:0;this.fps=0;this.fpsTime=0;this.fpsCounter=0;this.fpsDynamicWait=0;this.width=0;this.height=0;this.layerX=null;this.layerY=null;this.layerWidth=null;this.layerHeight=null;this.layerContainer=null;this.looping=false;this.touchEmulatesMouse=false;this.firstFrame=true;this.layers={};this.previousTouchInfo={};this.lastLayerZIndex=0;this.startTime=0;this.totalDuration=0;this.lastTotalDuration=0;this.lastFrameDuration=0;this.frameCount=0;this.version='1.0';this.scene={canvas:this};this.kb={down:[],ctrl:false,shift:false,alt:false,isDown:function(keyCode){for(var i=0;i<this.down.length;i++){if(this.down[i]['code']==keyCode){return true;}}
return false;}}
this.mouse={left:false,right:false,middle:false,x:0,y:0,scroll:0}
this.init=function(){if(renderCallback!=null){this.setRenderCallback(renderCallback);}
if(typeof(canvas)=='object'){this.canvasElement=canvas;}else if(typeof(canvas)=='string'){this.canvasElement=document.getElementById(canvas);}else{this.handleError('Invalid canvas reference given, expected canvas element or id');return;}
if(this.canvasElement==null){this.handleError('Canvas element could not be found');return;}
this.c=this.canvasElement.getContext(this.canvasContext);if(this.c==null){this.handleError('Given canvas element does not seem to be of canvas type, context not found');return;}
if(typeof(canvas)=='object'){this.width=canvas.width;this.height=canvas.height;}else{this.width=this.getWidth();this.height=this.getHeight();this.canvasElement.width=this.width;this.canvasElement.height=this.height;}
var self=this;if(this.drawOnly!=true){if(this.layerParent==null){window.onresize=function(){self.handleWindowResize();}
document.onkeydown=function(event){if(event==null){event=window.event;}
var keyCode=event.keyCode;var character=event.which==null?String.fromCharCode(event.keyCode):String.fromCharCode(event.which);var isCtrlPressed=event.ctrlKey?true:false;var isShiftPressed=event.shiftKey?true:false;var isAltPressed=event.altKey?true:false;if(!self.kb.isDown(keyCode)){self.kb['down'].push({'code':keyCode,'character':character});}
self.kb['ctrl']=isCtrlPressed;self.kb['shift']=isShiftPressed;self.kb['alt']=isAltPressed;for(var layerName in self.layers){self.layers[layerName].kb=self.kb;self.layers[layerName].onKeyDown(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);}
return self.onKeyDown(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);};document.onkeyup=function(event){if(event==null){event=window.event;}
var keyCode=event.keyCode;var character=event.which==null?String.fromCharCode(event.keyCode):String.fromCharCode(event.which);var isCtrlPressed=event.ctrlKey?true:false;var isShiftPressed=event.shiftKey?true:false;var isAltPressed=event.altKey?true:false;var newKbDown=[];for(var i=0;i<self.kb['down'].length;i++){if(self.kb['down'][i]['code']!=keyCode){newKbDown.push({'code':self.kb['down'][i]['code'],'character':self.kb['down'][i]['character']});}}
self.kb['down']=newKbDown;self.kb['ctrl']=isCtrlPressed;self.kb['shift']=isShiftPressed;self.kb['alt']=isAltPressed;for(var layerName in self.layers){self.layers[layerName].kb=self.kb;self.layers[layerName].onKeyUp(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);}
return self.onKeyUp(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);}
document.onkeypress=function(event){if(event==null){event=window.event;}
var keyCode=event.charCode;var character=event.which==null?String.fromCharCode(event.keyCode):String.fromCharCode(event.which);var isCtrlPressed=event.ctrlKey?true:false;var isShiftPressed=event.shiftKey?true:false;var isAltPressed=event.altKey?true:false;for(var layerName in self.layers){self.layers[layerName].kb=self.kb;self.layers[layerName].onKeyPress(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);}
return self.onKeyPress(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed);}}
this.canvasElement.addEventListener('touchstart',function(event){var touchCount=event.changedTouches.length;var touches=[];var touch=null;for(var i=0;i<touchCount;i++){touch=event.changedTouches[i];var touchInfo={pageX:touch.pageX,pageY:touch.pageY,clientX:touch.clientX,clientY:touch.clientY,screenX:touch.screenX,screenY:touch.screenY,target:touch.target,identifier:touch.identifier}
self.onTouchStart(touchInfo,i,touchCount,event);touches.push(touchInfo);self.previousTouchInfo[touch.identifier]=touchInfo;}
if(touchCount==1){touch=event.changedTouches[0];var x=touch.clientX;var y=touch.clientY;if(self.touchEmulatesMouse){self.mouse.x=x;self.mouse.y=y;self.mouse.left=true;if(self.layerParent!=null){self.layerParent.onMouseDown(x,y,0);}
self.onMouseDown(x,y,0);}}else{self.onMultiTouchStart(touches,event);}},false);this.canvasElement.addEventListener('touchmove',function(event){var touchCount=event.changedTouches.length;var touches=[];var touch=null;for(var i=0;i<touchCount;i++){touch=event.changedTouches[i];var touchInfo={pageX:touch.pageX,pageY:touch.pageY,clientX:touch.clientX,clientY:touch.clientY,screenX:touch.screenX,screenY:touch.screenY,target:touch.target,identifier:touch.identifier}
self.onTouchMove(touchInfo,i,touchCount,(typeof(self.previousTouchInfo[touch.identifier])!='undefined'?self.previousTouchInfo[touch.identifier]:null),event);touches.push(touchInfo);}
if(touchCount==1){touch=event.changedTouches[0];var x=touch.clientX;var y=touch.clientY;if(self.touchEmulatesMouse){self.mouse.x=x;self.mouse.y=y;self.mouse.left=true;if(self.layerParent!=null){self.layerParent.onMouseMove(x,y);}
self.onMouseMove(x,y);}}else{self.onMultiTouchMove(touches,self.previousTouchInfo,event);}
for(var j=0;j<touches.length;j++){self.previousTouchInfo[touches[j].identifier]=touches[j];}},false);this.canvasElement.addEventListener('touchend',function(event){var touchCount=event.changedTouches.length;var touches=[];var touch=null;for(var i=0;i<touchCount;i++){touch=event.changedTouches[i];var touchInfo={pageX:touch.pageX,pageY:touch.pageY,clientX:touch.clientX,clientY:touch.clientY,screenX:touch.screenX,screenY:touch.screenY,target:touch.target,identifier:touch.identifier}
self.onTouchEnd(touchInfo,i,touchCount,event);touches.push(touchInfo);self.previousTouchInfo[touch.identifier]=null;}
if(touchCount==1){touch=event.changedTouches[0];var x=touch.clientX;var y=touch.clientY;if(self.touchEmulatesMouse){self.mouse.x=x;self.mouse.y=y;self.mouse.left=false;if(self.layerParent!=null){self.layerParent.onMouseUp(x,y,0);}
self.onMouseUp(x,y,0);}}else{self.onMultiTouchEnd(touches,event);}},false);this.canvasElement.addEventListener('mousedown',function(event){var x=null;var y=null;if(typeof(event.layerX)!='undefined'){x=event.layerX;y=event.layerY;}else if(typeof(event.offsetX)!='undefined'){x=event.offsetX;y=event.offsetY;}
var button=typeof(event.which)!='undefined'?event.which:event.button;if(button==1){self.mouse['left']=true;}else if(button==3){self.mouse['right']=true;}else if(button==2){self.mouse['middle']=true;}
self.mouse.x=x;self.mouse.y=y;for(var layerName in self.layers){self.layers[layerName].mouse=self.mouse;self.layers[layerName].onMouseDown(x,y,button);}
if(self.layerParent!=null){self.layerParent.mouse=self.mouse;self.layerParent.onMouseDown(x,y,button);for(layerName in self.layerParent.layers){var layer=self.layerParent.layers[layerName];if(layer!=this){layer.mouse=self.mouse;layer.onMouseDown(x,y,button);}}}
self.onMouseDown(x,y,button);return true;},false);this.canvasElement.addEventListener('mouseup',function(event){var x=null;var y=null;if(typeof(event.layerX)!='undefined'){x=event.layerX;y=event.layerY;}else if(typeof(event.offsetX)!='undefined'){x=event.offsetX;y=event.offsetY;}
var button=typeof(event.which)!='undefined'?event.which:event.button;if(button==1){self.mouse['left']=false;}else if(button==3){self.mouse['right']=false;}else if(button==2){self.mouse['middle']=false;}
self.mouse.x=x;self.mouse.y=y;for(var layerName in self.layers){self.layers[layerName].mouse=self.mouse;self.layers[layerName].onMouseUp(x,y,button);}
if(self.layerParent!=null){self.layerParent.mouse=self.mouse;self.layerParent.onMouseUp(x,y,button);for(layerName in self.layerParent.layers){var layer=self.layerParent.layers[layerName];if(layer!=this){layer.mouse=self.mouse;layer.onMouseUp(x,y,button);}}}
self.onMouseUp(x,y,button);return true;},false);this.canvasElement.addEventListener('mousemove',function(event){var x=null;var y=null;if(typeof(event.layerX)!='undefined'){x=event.layerX;y=event.layerY;}else if(typeof(event.offsetX)!='undefined'){x=event.offsetX;y=event.offsetY;}
self.mouse.x=x;self.mouse.y=y;for(var layerName in self.layers){self.layers[layerName].mouse=self.mouse;self.layers[layerName].onMouseMove(x,y);}
if(self.layerParent!=null){self.layerParent.mouse=self.mouse;self.layerParent.onMouseMove(x,y);for(layerName in self.layerParent.layers){var layer=self.layerParent.layers[layerName];if(layer!=this){layer.mouse=self.mouse;layer.onMouseMove(x,y);}}}
self.onMouseMove(x,y);return true;},false);this.canvasElement.oncontextmenu=function(event){if(!event){event=window.event;}
if(self.onContextMenu(event)===false){return false;}
return true;}
var onMouseWheelChange=function(event){var delta=0;if(!event){event=window.event;}
if(event.wheelDelta){delta=event.wheelDelta/120;if(window.opera){delta=-delta;}}else if(event.detail){delta=-event.detail/3;}
if(delta!=0){self.mouse.scroll+=delta;self.onMouseScroll(delta,self.mouse.scroll);}
if(event.preventDefault){event.preventDefault();}
event.returnValue=false;};this.canvasElement.addEventListener('DOMMouseScroll',onMouseWheelChange,false);this.canvasElement.onmousewheel=onMouseWheelChange;}
this.applyDefaultStyles();if(this.autostart){if(this.targetFPS!=0){this.start();}else{this.renderSingleFrame();}}}
this.getVersion=function(){return this.version;}
this.setRenderCallback=function(callback){if(typeof(callback)=='function'){this.renderCallback=callback;}else{this.handleError('Invalid render callback given, expected a function');}
return this;}
this.setTouchEmulatesMouse=function(doesTouchEmulateMouse){this.touchEmulatesMouse=doesTouchEmulateMouse;return this;}
this.setAutoResize=function(useAutoResize){this.autoResize=useAutoResize?true:false;return this;}
this.handleWindowResize=function(){if(this.autoResize&&this.onWindowResize(this.getWidth(),this.getHeight())!==false){if(this.layerParent==null){this.width=this.getWidth();this.height=this.getHeight();this.canvasElement.width=this.width;this.canvasElement.height=this.height;this.c.width=this.width;this.c.height=this.height;this.applyDefaultStyles();for(var layerKey in this.layers){this.layers[layerKey].handleWindowResize();}
if(!this.looping){this.renderSingleFrame();}}}}
this.onWindowResize=function(){}
this.onContextMenu=function(event){}
this.onKeyDown=function(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed){}
this.onKeyUp=function(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed){}
this.onKeyPress=function(keyCode,character,isCtrlPressed,isShiftPressed,isAltPressed){}
this.onMouseDown=function(x,y,button){}
this.onMouseUp=function(x,y,button){}
this.onMouseMove=function(x,y){}
this.onMouseScroll=function(delta,absolute){}
this.onTouchStart=function(info,index,count,event){}
this.onMultiTouchStart=function(touches,event){}
this.onTouchMove=function(info,index,count,previousInfo,event){}
this.onMultiTouchMove=function(touches,previousTouches,event){}
this.onTouchEnd=function(info,index,count,event){}
this.onMultiTouchEnd=function(touches,event){}
this.applyDefaultStyles=function(){this.fillStyle("#FF0000");this.strokeStyle("#00FF00");this.translate(0.5,0.5);this.font('12px Courier');return this;}
this.setTargetFramerate=function(fps){this.targetFPS=fps||60;this.targetFrameDuration=this.targetFPS>0?1000.0/this.targetFPS:0;this.looping=this.targetFPS!=0?true:false;return this;}
this.getTargetFramerate=function(){return this.targetFPS;}
this.getFPS=function(){return this.fps;}
this.createLayer=function(name,fps,renderCallback,zIndex,autostart){return this.createLayerAt(name,0,0,this.getWidth(),this.getHeight(),fps,renderCallback,zIndex,autostart);}
this.createLayerAt=function(name,x,y,width,height,fps,renderCallback,zIndex,autostart){fps=fps||0;zIndex=zIndex||this.lastLayerZIndex+1;autostart=autostart==null?true:autostart;var layerContainer=document.createElement('div');layerContainer.style.position='relative';layerContainer.style.marginLeft=x+'px';layerContainer.style.width=width+'px';layerContainer.style.height=height+'px';layerContainer.style.marginTop=(y-height)+'px';layerContainer.style.zIndex=zIndex;var layerCanvasElement=document.createElement('canvas');layerCanvasElement.id='canvas-layer-'+name;layerCanvasElement.width=width;layerCanvasElement.height=height;layerContainer.appendChild(layerCanvasElement);this.canvasElement.parentNode.insertBefore(layerContainer,this.canvasElement.nextSibling);var canvasObject=new Canvas(layerCanvasElement,fps,renderCallback,false,this);canvasObject.layerX=x;canvasObject.layerY=y;canvasObject.layerWidth=width;canvasObject.layerHeight=height;this.layers[name]=canvasObject;this.lastLayerZIndex=zIndex;if(autostart){if(fps!=0){canvasObject.start();}else{canvasObject.renderSingleFrame();}}
return canvasObject;}
this.getLayer=function(name){if(typeof(this.layers[name])!='undefined'){return this.layers[name];}else{return null;}}
this.renderToCanvas=function(width,height,fps,renderFunction){var buffer=document.createElement('canvas');buffer.width=width;buffer.height=height;var canvas=new Canvas(buffer,fps,renderFunction,null,true);return canvas.canvasElement;}
this.loadImage=function(url,loadedCallback,errorCallback){var image=new Image();var self=this;image.onload=function(){if(typeof(loadedCallback)=='function'){loadedCallback.apply(self,[this]);}}
image.onerror=function(){if(typeof(errorCallback)=='function'){errorCallback.apply(self,[this]);}}
image.src=url;}
this.drawImage=function(image,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10){var align=null;var rotation=null;var params=null;if(p5==null){align=p3;rotation=p4;params=this.resolveRenderParameters(p1,p2,image.width,image.height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.drawImage(image,params.sx,params.sy);this.restore();}else if(p7==null){align=p5;rotation=p6;params=this.resolveRenderParameters(p1,p2,image.width,image.height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.drawImage(image,params.sx,params.sy,p3,p4);this.restore();}else{align=p9;rotation=p10;params=this.resolveRenderParameters(p5,p6,image.width,image.height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.drawImage(image,p1,p2,p3,p4,params.sx,params.sy,p7,p8);this.restore();}
return this;}
this.getParent=function(){return this.layerParent;}
this.setZIndex=function(zIndex){this.canvasElement.style.zIndex=zIndex;return this;}
this.renderFrame=function(frameDuration,totalDuration,frameNumber){if(this.renderCallback!=null){this.save();this.renderCallback.apply(this,[frameDuration,totalDuration,frameNumber]);this.restore();if(this.firstFrame==true){this.firstFrame=false;}}
return this;}
this.renderSingleFrame=function(){return this.renderFrame(null,null,1);}
this.start=function(){this.looping=true;this.startTime=this.millis();this.fpsTime=this.millis();this.loop();return this;}
this.stop=function(){this.looping=false;return this;}
this.loop=function(){if(!this.looping){return;}
var currentTime=this.millis();this.totalDuration=currentTime-this.startTime;this.lastFrameDuration=Math.max(this.totalDuration-this.lastTotalDuration,1);this.frameCount++;this.renderFrame(this.lastFrameDuration,this.totalDuration,this.frameCount);this.lastTotalDuration=this.totalDuration;this.fpsCounter++;if(currentTime-this.fpsTime>=1000){this.fps=this.fpsCounter;this.fpsCounter=0;this.fpsTime=currentTime;}
if(this.targetFPS!=-1){if(this.fps>this.targetFPS){this.fpsDynamicWait+=(this.fps-this.targetFPS)/100.0;}else if(this.fps<this.targetFPS&&this.fpsDynamicWait>=1){this.fpsDynamicWait-=(this.targetFPS-this.fps)/100.0;}}else{this.fpsDynamicWait=0;}
var self=this;window.setTimeout(function(){self.loop();},Math.max(this.targetFrameDuration-this.lastFrameDuration+this.fpsDynamicWait,0));}
this.millis=function(){return(new Date()).getTime();}
this.getWidth=function(){if(this.layerWidth!=null){return this.layerWidth;}else{return this.canvasElement.clientWidth;}}
this.getHeight=function(){if(this.layerHeight!=null){return this.layerHeight;}else{return this.canvasElement.clientHeight;}}
this.save=function(){this.c.save();return this;}
this.restore=function(){this.c.restore();return this;}
this.scale=function(x,y){this.c.scale(x,y);return this;}
this.rotate=function(angle){this.c.rotate(angle);return this;}
this.translate=function(x,y){this.c.translate(x,y);return this;}
this.transform=function(a,b,c,d,e,f){this.c.transform(a,b,c,d,e,f);return this;}
this.setTransform=function(a,b,c,d,e,f){this.c.setTransform(a,b,c,d,e,f);return this;}
this.setGlobalAlpha=function(alpha){this.c.globalAlpha=alpha;return this;}
this.setCompositeOperation=function(operationName){this.c.globalCompositeOperation=operationName;return this;}
this.beginComposite=function(operationName){this.save();this.setCompositeOperation(operationName);}
this.endComposite=function(){this.restore();}
this.fillStyle=function(style){this.c.fillStyle=style;return this;}
this.fillColor=function(color){this.c.fillStyle=color;return this;}
this.strokeStyle=function(style,lineWidth,lineCap){this.c.strokeStyle=style;if(lineWidth!=null){this.c.lineWidth=lineWidth;}
if(lineCap!=null){this.c.lineCap=lineCap;}
return this;}
this.strokeColor=function(color){this.c.strokeStyle=color;return this;}
this.lineWidth=function(width){this.c.lineWidth=width;return this;}
this.lineCap=function(lineCap){this.c.lineCap=lineCap;return this;}
this.lineJoin=function(lineJoin){this.c.lineJoin=lineJoin;return this;}
this.color=function(fillColor,strokeColor){if(fillColor!=null)this.fillColor(fillColor);if(strokeColor!=null)this.strokeColor(strokeColor);return this;}
this.shadowStyle=function(offsetX,offsetY,blurRadius,color){this.c.shadowOffsetX=offsetX;this.c.shadowOffsetY=offsetY;if(blurRadius!=null)this.c.shadowBlur=blurRadius;if(!color!=null)this.c.shadowColor=color;return this;}
this.beginShadow=function(offsetX,offsetY,blurRadius,color){this.save();this.shadowStyle(offsetX,offsetY,blurRadius,color);return this;}
this.endShadow=function(){this.restore();}
this.createLinearGradient=function(startX,startY,endX,endY,stops){var gradient=this.c.createLinearGradient(startX,startY,endX,endY);if(stops!=null){for(var point in stops){gradient.addColorStop(parseFloat(point),stops[point]);}}
return gradient;}
this.beginLinearGradientFill=function(startX,startY,endX,endY,stops){this.save();var gradient=this.createLinearGradient(startX,startY,endX,endY,stops);this.fillStyle(gradient);return gradient;}
this.beginLinearGradientStroke=function(startX,startY,endX,endY,stops){this.save();var gradient=this.createLinearGradient(startX,startY,endX,endY,stops);this.strokeStyle(gradient);return gradient;}
this.beginLinearGradient=function(startX,startY,endX,endY,stops){this.save();var gradient=this.createLinearGradient(startX,startY,endX,endY,stops);this.fillStyle(gradient);this.strokeStyle(gradient);return gradient;}
this.createRadialGradient=function(x1,y1,radius1,x2,y2,radius2,stops){var gradient=this.c.createRadialGradient(x1,y1,radius1,x2,y2,radius2);if(stops!=null){for(var point in stops){gradient.addColorStop(parseFloat(point),stops[point]);}}
return gradient;}
this.beginRadialGradientFill=function(x1,y1,radius1,x2,y2,radius2,stops){this.save();var gradient=this.createRadialGradient(x1,y1,radius1,x2,y2,radius2,stops);this.fillStyle(gradient);return gradient;}
this.beginRadialGradientStroke=function(x1,y1,radius1,x2,y2,radius2,stops){this.save();var gradient=this.createRadialGradient(x1,y1,radius1,x2,y2,radius2,stops);this.strokeStyle(gradient);return gradient;}
this.beginRadialGradient=function(x1,y1,radius1,x2,y2,radius2,stops){this.save();var gradient=this.createRadialGradient(x1,y1,radius1,x2,y2,radius2,stops);this.fillStyle(gradient);this.strokeStyle(gradient);return gradient;}
this.endGradient=function(){this.restore();return this;}
this.fill=function(){this.c.fill();return this;}
this.stroke=function(){this.c.stroke();return this;}
this.beginPath=function(){this.c.beginPath();return this;}
this.closePath=function(){this.c.closePath();return this;}
this.moveTo=function(x,y){this.c.moveTo(x,y);return this;}
this.lineTo=function(x,y){this.c.lineTo(x,y);return this;}
this.quadraticCurveTo=function(controlPointX,controlPointY,x,y){this.c.quadraticCurveTo(controlPointX,controlPointY,x,y);return this;}
this.bezierCurveTo=function(fistControlPointX,firstControlPointY,secondControlPointX,secondControlPointY,x,y){this.c.bezierCurveTo(fistControlPointX,firstControlPointY,secondControlPointX,secondControlPointY,x,y);return this;}
this.font=function(definition){this.c.font=definition;return this;}
this.textAlign=function(align){this.c.textAlign=align;return this;}
this.textBaseline=function(baseline){this.c.textBaseline=baseline;return this;}
this.clearRect=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.clearRect(params.sx,params.sy,params.w,params.h);this.restore();return this;}
this.clear=function(){return this.clearRect(0,0,this.getWidth(),this.getHeight());}
this.text=function(text,x,y,align,rotation){rotation=rotation||0;align=align||'start-top';var alignParts=align.split('-');var textAlign=alignParts[0];var textBaseline=alignParts[1];this.save();this.translate(x,y);if(rotation!=0)this.rotate(rotation*(Math.PI/180.0));this.textAlign(textAlign);this.textBaseline(textBaseline);this.c.fillText(text,0,0);this.restore();return this;}
this.fillText=function(text,x,y,align,rotation){rotation=rotation||0;align=align||'start-top';var alignParts=align.split('-');var textAlign=alignParts[0];var textBaseline=alignParts[1];this.save();this.translate(x,y);this.beginPath();if(rotation!=0)this.rotate(rotation*(Math.PI/180.0));this.textAlign(textAlign);this.textBaseline(textBaseline);this.c.fillText(text,0,0);this.fill();this.restore();return this;}
this.strokeText=function(text,x,y,align,rotation){rotation=rotation||0;align=align||'start-top';var alignParts=align.split('-');var textAlign=alignParts[0];var textBaseline=alignParts[1];this.save();this.translate(x,y);this.rotate(rotation*(Math.PI/180.0));this.textAlign(textAlign);this.textBaseline(textBaseline);this.c.strokeText(text,0,0);this.stroke();this.restore();return this;}
this.rect=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.rect(params.sx,params.sy,params.w,params.h);this.restore();return this;}
this.fillRect=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.fillRect(params.sx,params.sy,params.w,params.h);this.restore();return this;}
this.strokeRect=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.strokeRect(params.sx,params.sy,params.w,params.h);this.restore();return this;}
this.roundedRect=function(x,y,width,height,radius,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);this.save();this.translate(params.tx,params.ty);this.moveTo(params.sx+radius,params.sy);this.lineTo(params.sx+width-radius,params.sy);this.quadraticCurveTo(params.sx+width,params.sy,params.sx+width,params.sy+radius);this.lineTo(params.sx+width,params.sy+height-radius);this.quadraticCurveTo(params.sx+width,params.sy+height,params.sx+width-radius,params.sy+height);this.lineTo(params.sx+radius,params.sy+height);this.quadraticCurveTo(params.sx,params.sy+height,params.sx,params.sy+height-radius);this.lineTo(params.sx,params.sy+radius);this.quadraticCurveTo(params.sx,params.sy,params.sx+radius,params.sy);this.restore();return this;}
this.fillRoundedRect=function(x,y,width,height,radius,align,rotation){this.beginPath();this.roundedRect(x,y,width,height,radius,align,rotation);this.closePath();this.fill();return this;}
this.strokeRoundedRect=function(x,y,width,height,radius,align,rotation){this.beginPath();this.roundedRect(x,y,width,height,radius,align,rotation);this.closePath();this.stroke();return this;}
this.line=function(x1,y1,x2,y2){this.moveTo(x1,y1);this.lineTo(x2,y2);return this;}
this.strokeLine=function(x1,y1,x2,y2){this.beginPath();this.line(x1,y1,x2,y2);this.stroke();return this;}
this.arc=function(x,y,radius,startAngle,endAngle,anticlockwise,align,rotation){var params=this.resolveRenderParameters(x,y,radius*2.0,radius*2.0,align,rotation);this.save();this.translate(params.tx+radius,params.ty+radius);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.c.arc(params.sx,params.sy,radius,startAngle*(Math.PI/180.0),endAngle*(Math.PI/180.0),anticlockwise);this.restore();return this;}
this.fillArc=function(x,y,radius,startAngle,endAngle,anticlockwise,align,rotation){var params=this.resolveRenderParameters(x,y,radius*2.0,radius*2.0,align,rotation);this.save();this.translate(params.tx+radius,params.ty+radius);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.beginPath();this.c.arc(params.sx,params.sy,radius,startAngle*(Math.PI/180.0),endAngle*(Math.PI/180.0),anticlockwise);this.fill();this.restore();return this;}
this.strokeArc=function(x,y,radius,startAngle,endAngle,anticlockwise,close,align,rotation){close=close||false;var params=this.resolveRenderParameters(x,y,radius*2.0,radius*2.0,align,rotation);this.save();this.translate(params.tx+radius,params.ty+radius);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.beginPath();this.c.arc(params.sx,params.sy,radius,startAngle*(Math.PI/180.0),endAngle*(Math.PI/180.0),anticlockwise);if(close)this.closePath();this.stroke();this.restore();return this;}
this.circle=function(x,y,radius,align){this.arc(x,y,radius,0,360,false,align);return this;}
this.fillCircle=function(x,y,radius,align){this.fillArc(x,y,radius,0,360,false,align);return this;}
this.strokeCircle=function(x,y,radius,align){this.strokeArc(x,y,radius,0,360,false,true,align);return this;}
this.ellipse=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);var hB=(width/2)*.5522848,vB=(height/2)*.5522848,eX=params.sx+width,eY=params.sy+height,mX=params.sx+width/2,mY=params.sy+height/2;this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.moveTo(params.sx,mY);this.bezierCurveTo(params.sx,mY-vB,mX-hB,params.sy,mX,params.sy);this.bezierCurveTo(mX+hB,params.sy,eX,mY-vB,eX,mY);this.bezierCurveTo(eX,mY+vB,mX+hB,eY,mX,eY);this.bezierCurveTo(mX-hB,eY,params.sx,mY+vB,params.sx,mY);this.restore();return this;}
this.fillEllipse=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);var hB=(width/2)*.5522848,vB=(height/2)*.5522848,eX=params.sx+width,eY=params.sy+height,mX=params.sx+width/2,mY=params.sy+height/2;this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.beginPath();this.moveTo(params.sx,mY);this.bezierCurveTo(params.sx,mY-vB,mX-hB,params.sy,mX,params.sy);this.bezierCurveTo(mX+hB,params.sy,eX,mY-vB,eX,mY);this.bezierCurveTo(eX,mY+vB,mX+hB,eY,mX,eY);this.bezierCurveTo(mX-hB,eY,params.sx,mY+vB,params.sx,mY);this.closePath();this.fill();this.restore();return this;}
this.strokeEllipse=function(x,y,width,height,align,rotation){var params=this.resolveRenderParameters(x,y,width,height,align,rotation);var hB=(width/2)*.5522848,vB=(height/2)*.5522848,eX=params.sx+width,eY=params.sy+height,mX=params.sx+width/2,mY=params.sy+height/2;this.save();this.translate(params.tx,params.ty);if(params.r!=0)this.rotate(params.r*(Math.PI/180.0));this.beginPath();this.moveTo(params.sx,mY);this.bezierCurveTo(params.sx,mY-vB,mX-hB,params.sy,mX,params.sy);this.bezierCurveTo(mX+hB,params.sy,eX,mY-vB,eX,mY);this.bezierCurveTo(eX,mY+vB,mX+hB,eY,mX,eY);this.bezierCurveTo(mX-hB,eY,params.sx,mY+vB,params.sx,mY);this.closePath();this.stroke();this.restore();return this;}
this.grid=function(xStep,yStep,x,y,width,height,rotation){xStep=xStep||50;yStep=yStep||50;x=x||0;y=y||0;width=width||this.getWidth();height=height||this.getHeight();rotation=rotation||0;this.save();this.translate(x,y);this.rotate(rotation*(Math.PI/180.0));for(var lineX=xStep;lineX<width;lineX+=xStep){for(var lineY=yStep;lineY<height;lineY+=yStep){this.strokeLine(lineX,0,lineX,height);this.strokeLine(0,lineY,width,lineY);}}
this.restore();}
this.resolveRenderParameters=function(x,y,width,height,align,rotation){align=align||ALIGN.LEFT.TOP;rotation=rotation||0;var aligns=align.split('-');var useTranslationX=x;var useTranslationY=y;var useStartX=0;var useStartY=0;var useWidth=width;var useHeight=height;if(aligns[0]=='center'){useStartX=-width/2.0;}else if(aligns[0]=='right'){useStartX=-width;}
if(aligns[1]=='middle'){useStartY=-height/2.0;}else if(aligns[1]=='bottom'){useTranslationY=y-height;}
return{tx:useTranslationX,ty:useTranslationY,sx:useStartX,sy:useStartY,w:useWidth,h:useHeight,r:rotation};}
this.errorHandler=function(message){alert('Canvas error: "'+message+'"');}
this.setErrorHandler=function(errorHandler){if(typeof(errorHandler)=='function'||errorHandler==null){this.errorHandler=errorHandler;}else{this.handleError('Trying to set invalid error handler, a function expected but got a '+typeof(errorHandler));}
return this;}
this.handleError=function(message){if(typeof(this.errorHandler)=='function'){this.errorHandler(message);}}
this.init();}
var rad=function(radians){return radians*180/Math.PI;}
var CAP={ROUND:'round',SQUARE:'square',BUTT:'butt'};var JOIN={BEVEL:'bevel',ROUND:'round',MITER:'miter'};var ALIGN={LEFT:{TOP:'left-top',MIDDLE:'left-middle',BOTTOM:'left-bottom',HANGING:'left-hanging',ALPHABETIC:'left-alphabetic',IDEOGRAPHIC:'left-ideographic'},CENTER:{TOP:'center-top',MIDDLE:'center-middle',BOTTOM:'center-bottom',HANGING:'center-hanging',ALPHABETIC:'center-alphabetic',IDEOGRAPHIC:'center-ideographic'},RIGHT:{TOP:'right-top',MIDDLE:'right-middle',BOTTOM:'right-bottom',HANGING:'right-hanging',ALPHABETIC:'right-alphabetic',IDEOGRAPHIC:'right-ideographic'},START:{TOP:'start-top',MIDDLE:'start-middle',BOTTOM:'start-bottom',HANGING:'start-hanging',ALPHABETIC:'start-alphabetic',IDEOGRAPHIC:'start-ideographic'},END:{TOP:'end-top',MIDDLE:'end-middle',BOTTOM:'end-bottom',HANGING:'end-hanging',ALPHABETIC:'end-alphabetic',IDEOGRAPHIC:'end-ideographic'}};var OP={SOURCE_OVER:'source-over',SOURCE_IN:'source-in',SOURCE_OUT:'source-out',SOURCE_ATOP:'source-atop',DESTINATION_OVER:'destination-over',DESTINATION_IN:'destination-in',DESTINATION_OUT:'destination-out',DESTINATION_ATOP:'destination-atop',LIGHTER:'lighter',COPY:'copy',XOR:'xor'};var KC={CANCEL:3,HELP:6,BACK_SPACE:8,TAB:9,CLEAR:12,RETURN:13,ENTER:14,SHIFT:16,CONTROL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINTSCREEN:44,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,SEMICOLON:59,EQUALS:61,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,CONTEXT_MENU:93,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SEPARATOR:108,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NUM_LOCK:144,SCROLL_LOCK:145,COMMA:188,PERIOD:190,SLASH:191,BACK_QUOTE:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,QUOTE:222,META:224};